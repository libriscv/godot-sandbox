
#!/usr/bin/env python
import os

Import("env")
Import("env_modules")

def get_addon_target():
	return "template_release"

def get_addon_platform():
	return env["platform"].replace("linuxbsd", "linux")

def get_sufix():
    suffix = ".{}.{}".format(get_addon_platform(), get_addon_target())
    # In godot it's "linuxbsd"
    if env["precision"] == "double":
        suffix += ".double"
    suffix += "." + env["arch"]
    if not env["threads"]:
        suffix += ".nothreads"
    return suffix

os.system("scons platform=" + get_addon_platform() + " target=" + get_addon_target())

match get_addon_platform():
	case "macos":
		base_path = "#modules/sandbox/bin/addons/godot_sandbox/bin/libgodot_riscv.macos.template_release.universal.framework/"
	case _:
		base_path = "#modules/sandbox/bin/addons/godot_sandbox/bin"

base_file = "libgodot_riscv{}".format(get_sufix())

env_gdextension = env_modules.Clone()

env_gdextension.Append(LIBS=[base_file])
env_gdextension.Append(LIBPATH=[base_path])

# Godot-cpp
base_path = "#modules/sandbox/ext/godot-cpp/bin"
base_file = "libgodot-cpp{}".format(get_sufix())

env_gdextension.Append(LIBS=[base_file])
env_gdextension.Append(LIBPATH=[base_path])

# Sources

env_gdextension.add_source_files(env.modules_sources, "*.cpp")
